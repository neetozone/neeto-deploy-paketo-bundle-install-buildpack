#!/usr/bin/env bash

set -eu
set -o pipefail

readonly ROOT_DIR="$(cd "$(dirname "${0}")/.." && pwd)"
readonly BIN_DIR="${ROOT_DIR}/.bin"
readonly BUILD_DIR="${ROOT_DIR}/build"

# shellcheck source=SCRIPTDIR/.util/tools.sh
source "${ROOT_DIR}/scripts/.util/tools.sh"

# shellcheck source=SCRIPTDIR/.util/print.sh
source "${ROOT_DIR}/scripts/.util/print.sh"

function main {
  local version output token
  token=""

  while [[ "${#}" != 0 ]]; do
    case "${1}" in
      --version|-v)
        version="${2}"
        shift 2
        ;;

      --output|-o)
        output="${2}"
        shift 2
        ;;

      --token|-t)
        token="${2}"
        shift 2
        ;;

      --help|-h)
        shift 1
        usage
        exit 0
        ;;

      "")
        # skip if the argument is empty
        shift 1
        ;;

      *)
        util::print::error "unknown argument \"${1}\""
    esac
  done

  if [[ -z "${version:-}" ]]; then
    usage
    echo
    util::print::error "--version is required"
  fi

  if [[ -z "${output:-}" ]]; then
    output="${BUILD_DIR}/buildpackage.cnb"
  fi

  repo::prepare

  tools::install "${token}"

  buildpack_type=buildpack
  if [ -f "${ROOT_DIR}/extension.toml" ]; then
    buildpack_type=extension
  fi

  # Read targets from buildpack.toml
  local -a targets=()
  local buildpack_toml="${ROOT_DIR}/buildpack.toml"
  if [[ -f "${buildpack_toml}" ]]; then
    util::print::info "Reading targets from ${buildpack_toml}..."
    local targets_json
    targets_json=$(cat "${buildpack_toml}" | yj -tj | jq -r '.targets[]? | "\(.os)/\(.arch)"' 2>/dev/null || echo "")
    
    if [[ -n "${targets_json}" ]]; then
      while IFS= read -r target; do
        if [[ -n "${target}" ]]; then
          targets+=("${target}")
        fi
      done <<< "${targets_json}"
      util::print::info "Found ${#targets[@]} target(s) in buildpack.toml: ${targets[*]}"
    fi
  fi

  if [[ ${#targets[@]} -gt 0 ]]; then
    # Build and package for each target architecture separately
    local arch_outputs=()
    for target in "${targets[@]}"; do
      local arch
      arch=$(echo "${target}" | cut -d'/' -f2)
      util::print::title "Building binaries for ${target} (arch: ${arch})..."
      
      # Clean bin directory before building for this architecture
      rm -rf "${ROOT_DIR}/bin"
      mkdir -p "${ROOT_DIR}/bin"
      
      # Build archive for this architecture (GOARCH will be used by jam pack's pre-package script)
      export GOARCH="${arch}"
      buildpack::archive "${version}" "${buildpack_type}" "${target}"
      unset GOARCH
      
      # Package with this target
      local arch_output="${output%.cnb}-${arch}.cnb"
      arch_outputs+=("${arch_output}")
      buildpackage::create "${arch_output}" "${buildpack_type}" "${target}"
    done
    
    # Create a combined output by copying the first one (for compatibility)
    if [[ ${#arch_outputs[@]} -gt 0 ]]; then
      cp "${arch_outputs[0]}" "${output}"
      util::print::title "Created architecture-specific packages:"
      for arch_output in "${arch_outputs[@]}"; do
        echo "  - ${arch_output}"
      done
      echo "  - ${output} (copy of ${arch_outputs[0]})"
    fi
  else
    buildpack::archive "${version}" "${buildpack_type}"
    buildpackage::create "${output}" "${buildpack_type}"
  fi
}

function usage() {
  cat <<-USAGE
package.sh --version <version> [OPTIONS]

Packages a buildpack or an extension into a buildpackage .cnb file.

Targets are automatically read from buildpack.toml [[targets]] sections.

OPTIONS
  --help               -h            prints the command usage
  --version <version>  -v <version>  specifies the version number to use when packaging a buildpack or an extension
  --output <output>    -o <output>   location to output the packaged buildpackage or extension artifact (default: ${ROOT_DIR}/build/buildpackage.cnb)
  --token <token>                    Token used to download assets from GitHub (e.g. jam, pack, etc) (optional)
USAGE
}

function repo::prepare() {
  util::print::title "Preparing repo..."

  rm -rf "${BUILD_DIR}"

  mkdir -p "${BIN_DIR}"
  mkdir -p "${BUILD_DIR}"

  export PATH="${BIN_DIR}:${PATH}"
}

function tools::install() {
  local token
  token="${1}"

  util::tools::pack::install \
    --directory "${BIN_DIR}" \
    --token "${token}"

  util::tools::yj::install \
    --directory "${BIN_DIR}" \
    --token "${token}"

  if [[ -f "${ROOT_DIR}/.libbuildpack" ]]; then
    util::tools::packager::install \
      --directory "${BIN_DIR}"
  else
    util::tools::jam::install \
      --directory "${BIN_DIR}" \
      --token "${token}"
  fi
}

function buildpack::archive() {
  local version
  version="${1}"
  buildpack_type="${2}"
  local target="${3:-}"

  local archive_name="buildpack.tgz"
  if [[ -n "${target}" ]]; then
    local arch
    arch=$(echo "${target}" | cut -d'/' -f2)
    archive_name="buildpack-${arch}.tgz"
  fi

  util::print::title "Packaging ${buildpack_type} into ${BUILD_DIR}/${archive_name}..."

  if [[ -f "${ROOT_DIR}/.libbuildpack" ]]; then
    packager \
      --uncached \
      --archive \
      --version "${version}" \
      "${BUILD_DIR}/buildpack"
  else
    jam pack \
      "--${buildpack_type}" "${ROOT_DIR}/${buildpack_type}.toml"\
      --version "${version}" \
      --output "${BUILD_DIR}/${archive_name}"
  fi
}

function buildpackage::create() {
  local output buildpack_type
  output="${1}"
  buildpack_type="${2}"
  shift 2
  local targets=("${@:-}")

  util::print::title "Packaging ${buildpack_type}... ${output}"

  # Determine archive path based on target
  local archive_path="${BUILD_DIR}/buildpack.tgz"
  if [[ ${#targets[@]} -eq 1 ]]; then
    local arch
    arch=$(echo "${targets[0]}" | cut -d'/' -f2)
    archive_path="${BUILD_DIR}/buildpack-${arch}.tgz"
    if [[ ! -f "${archive_path}" ]]; then
      archive_path="${BUILD_DIR}/buildpack.tgz"
    fi
  fi

  if [ "$buildpack_type" == "extension" ]; then
    cwd=$(pwd)
    cd ${BUILD_DIR}
    mkdir -p cnbdir
    cd cnbdir
    cp "${archive_path}" .
    tar -xvf buildpack*.tgz
    rm buildpack*.tgz

    pack_args=(
      extension package "${output}"
      --format file
    )
    
    if [[ ${#targets[@]} -gt 0 ]]; then
      for target in "${targets[@]}"; do
        pack_args+=(--target "${target}")
      done
    fi

    pack "${pack_args[@]}"

    cd $cwd
  else
    pack_args=(
      buildpack package "${output}"
      --path "${archive_path}"
      --format file
    )
    
    if [[ ${#targets[@]} -gt 0 ]]; then
      for target in "${targets[@]}"; do
        pack_args+=(--target "${target}")
      done
    fi

    pack "${pack_args[@]}"
  fi
}

main "${@:-}"